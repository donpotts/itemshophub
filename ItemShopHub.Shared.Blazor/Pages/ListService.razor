@page "/services/list"
@using ItemShopHub.Shared.Models
@using ItemShopHub.Shared.Blazor.Services
@inject AppService AppService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@inject IDialogService DialogService

<PageTitle>Manage Services</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudStack Spacing="4">
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
            <MudText Typo="Typo.h4">
                <MudIcon Icon="@Icons.Material.Filled.Build" Class="mr-2" />
                Manage Services
            </MudText>
            <MudButton Variant="Variant.Filled" 
                      Color="Color.Primary" 
                      StartIcon="@Icons.Material.Filled.Add"
                      OnClick="NavigateToAdd">
                Add Service
            </MudButton>
        </MudStack>

        <MudPaper Class="pa-4" Elevation="2">
            <MudStack Row="true" Spacing="3" AlignItems="AlignItems.Center" Class="mb-4">
                <MudTextField @bind-Value="searchTerm" 
                            Label="Search services..." 
                            Variant="Variant.Outlined"
                            Adornment="Adornment.End" 
                            AdornmentIcon="@Icons.Material.Filled.Search"
                            OnKeyUp="OnSearchKeyUp"
                            Class="flex-grow-1" />
                <MudButton Variant="Variant.Outlined" OnClick="LoadServices">Refresh</MudButton>
            </MudStack>

            @if (isLoading)
            {
                <MudProgressLinear Indeterminate="true" Class="mb-4" />
            }

            @if (services == null)
            {
                <MudProgressCircular Indeterminate="true" />
            }
            else if (!services.Any())
            {
                <MudPaper Class="pa-8" Elevation="1">
                    <MudStack AlignItems="AlignItems.Center" Spacing="4">
                        <MudIcon Icon="@Icons.Material.Filled.Build" Size="Size.Large" Color="Color.Default" />
                        <MudText Typo="Typo.h6">No services found</MudText>
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="NavigateToAdd">
                            Add Your First Service
                        </MudButton>
                    </MudStack>
                </MudPaper>
            }
            else
            {
                <MudDataGrid Items="@filteredServices" 
                           Loading="@isLoading"
                           Hover="true" 
                           Breakpoint="Breakpoint.Sm"
                           Height="600px"
                           FixedHeader="true">
                    <Columns>
                        <PropertyColumn Property="x => x.Name" Title="Name" />
                        <PropertyColumn Property="x => x.PricingType" Title="Pricing" />
                        <PropertyColumn Property="x => x.GetBasePrice()" Title="Price" Format="C" />
                        <PropertyColumn Property="x => x.Complexity" Title="Complexity" />
                        <PropertyColumn Property="x => x.IsAvailable" Title="Available">
                            <CellTemplate>
                                <MudChip Color="@(context.Item.IsAvailable ? Color.Success : Color.Default)" 
                                        Size="Size.Small">
                                    @(context.Item.IsAvailable ? "Yes" : "No")
                                </MudChip>
                            </CellTemplate>
                        </PropertyColumn>
                        <PropertyColumn Property="x => x.CreatedDate" Title="Created" Format="yyyy-MM-dd" />
                        <TemplateColumn CellClass="d-flex justify-end" Sortable="false">
                            <CellTemplate>
                                <MudStack Row="true" Spacing="1">
                                    <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                                 Color="Color.Primary" 
                                                 Size="Size.Small"
                                                 OnClick="@(() => NavigateToEdit(context.Item.Id))" />
                                    <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                                 Color="Color.Error" 
                                                 Size="Size.Small"
                                                 OnClick="@(() => DeleteService(context.Item))" />
                                </MudStack>
                            </CellTemplate>
                        </TemplateColumn>
                    </Columns>
                </MudDataGrid>
            }
        </MudPaper>
    </MudStack>
</MudContainer>

@code {
    private IEnumerable<Service>? services;
    private IEnumerable<Service> filteredServices => services?.Where(FilterService) ?? Enumerable.Empty<Service>();
    private string searchTerm = string.Empty;
    private bool isLoading = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadServices();
    }

    private async Task LoadServices()
    {
        isLoading = true;
        try
        {
            services = await AppService.GetServicesAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading services: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    private bool FilterService(Service service)
    {
        if (string.IsNullOrWhiteSpace(searchTerm))
            return true;

        var searchLower = searchTerm.ToLowerInvariant();
        return (service.Name?.ToLowerInvariant().Contains(searchLower) ?? false) ||
               (service.Description?.ToLowerInvariant().Contains(searchLower) ?? false) ||
               service.PricingType.ToString().ToLowerInvariant().Contains(searchLower) ||
               service.Complexity.ToString().ToLowerInvariant().Contains(searchLower);
    }

    private void OnSearchKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            StateHasChanged();
        }
    }

    private void NavigateToAdd()
    {
        Navigation.NavigateTo("/services/add");
    }

    private void NavigateToEdit(long? serviceId)
    {
        if (serviceId.HasValue)
        {
            Navigation.NavigateTo($"/services/edit/{serviceId}");
        }
    }

    private async Task DeleteService(Service service)
    {
        bool? result = await DialogService.ShowMessageBox(
            "Delete Service",
            $"Are you sure you want to delete '{service.Name}'?",
            yesText: "Delete", cancelText: "Cancel");

        if (result == true)
        {
            try
            {
                await AppService.DeleteServiceAsync(service.Id ?? 0);
                Snackbar.Add("Service deleted successfully", Severity.Success);
                await LoadServices();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error deleting service: {ex.Message}", Severity.Error);
            }
        }
    }
}
